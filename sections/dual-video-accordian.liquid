{{ 'dual-accordion-video.css' | asset_url | stylesheet_tag }}

<section class="dual-acc-sec section-{{ section.id }} color-{{ section.settings.color_scheme }} background section-{{ section.id }}-paddings">
  <div class="container">
    <div
      class="dual-acc-wrapper"
      id="dual-acc-{{ section.id }}"
      style="--dual-bg: url({{ section.settings.bg_image | image_url }});"
      data-dual-acc-id="{{ section.id }}"
    >
      <!-- LEFT -->
      <div class="dual-left">
        <div class="left-content desktop">
          {% if section.settings.left_title != blank %}
            <h2 class="title--section h1">{{ section.settings.left_title }}</h2>
          {% endif %}
          {% if section.settings.left_text != blank %}
            <p class="left-text">{{ section.settings.left_text }}</p>
          {% endif %}
        </div>

        <div class="left-accordion-item">
          <button class="left-accordion-btn" type="button" aria-expanded="false">
            <span>
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon custom-icon-plus" aria-label="Collapsed">
                <path d="M12 18L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                <path d="M18 12L6 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
              </svg>
            </span>

            <div class="title-subtitle-wrpa">
              {% if section.settings.left_acc_title_sub != blank %}
                <p>{{ section.settings.left_acc_title_sub }}</p>
              {% endif %}
              {% if section.settings.left_acc_title != blank %}
                <h4>{{ section.settings.left_acc_title }}</h4>
              {% endif %}
            </div>
          </button>

          {% if section.settings.left_acc_text != blank %}
            <div class="left-accordion-desc">{{ section.settings.left_acc_text }}</div>
          {% endif %}
        </div>
      </div>

      <!-- RIGHT -->
      <div class="dual-right">
        <div class="left-content mobile-show-only">
          {% if section.settings.left_title != blank %}
            <h2 class="title--section h1">{{ section.settings.left_title }}</h2>
          {% endif %}
        </div>

        <!-- DEFAULT RIGHT: accordion list -->
        <div class="right-default-content">
          {% for block in section.blocks %}
            {% if block.settings.title != blank %}
              <div class="right-acc-item" {{ block.shopify_attributes }}>
                <button
                  class="right-acc-btn"
                  type="button"
                  aria-expanded="false"
                  aria-controls="right-acc-desc-{{ block.id }}"
                >
                  {{ block.settings.title }}
                  <span>
                    <svg class="plus-icon" width="9" height="9" viewBox="0 0 9 9" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                      <line x1="4.5" y1="0" x2="4.5" y2="9" stroke="white"/>
                      <line x1="9" y1="4.5" x2="0" y2="4.5" stroke="white"/>
                    </svg>

                    <svg class="minus-icon" width="10" height="1" viewBox="0 0 10 1" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                      <line x1="10" y1="0.5" x2="0" y2="0.5" stroke="white"/>
                    </svg>
                  </span>
                </button>

                <div class="right-acc-desc" id="right-acc-desc-{{ block.id }}">
                  <div class="right-acc-desc__inner">
                    {{ block.settings.text }}
                  </div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>

        <!-- ACTIVE RIGHT: reveal panel (video left, text right) -->
        <div class="right-reveal-content" aria-hidden="true">
          <div class="reveal-panel">
            <div class="reveal-media">
              <video
                id="right-video"
                playsinline
                muted
                loop
                preload="metadata"
              >
                {% if section.settings.left_video.sources[0].url == blank %}
                  <source src="{{ section.settings.left_video.sources[1].url }}" type="video/mp4">
                {% else %}
                  <source src="{{ section.settings.left_video.sources[0].url }}" type="video/mp4">
                {% endif %}
              </video>
            </div>

            <div class="reveal-content">
              <!-- Desktop close -->
              {% comment %} <button class="reveal-close" type="button" aria-label="Close">&minus;</button> {% endcomment %}

              <div class="reveal-text">
                {% if section.settings.left_acc_title_sub != blank %}
                  <div class="reveal-eyebrow">{{ section.settings.left_acc_title_sub }}</div>
                {% endif %}

                {% if section.settings.left_acc_title != blank %}
                  <h3 class="reveal-title">{{ section.settings.left_acc_title }}</h3>
                {% endif %}

                {% if section.settings.left_acc_text != blank %}
                  <div class="reveal-body">{{ section.settings.left_acc_text }}</div>
                {% endif %}
              </div>

              <!-- Mobile close pill (matches left-accordion-btn) -->
              <button class="left-accordion-btn reveal-close-mobile" type="button" aria-label="Close">
                <span>
                  <!-- Minus icon -->
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M18 12L6 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                  </svg>
                </span>

                <div class="title-subtitle-wrpa">
                  {% if section.settings.left_acc_title_sub != blank %}
                    <p>{{ section.settings.left_acc_title_sub }}</p>
                  {% endif %}
                  {% if section.settings.left_acc_title != blank %}
                    <h4>{{ section.settings.left_acc_title }}</h4>
                  {% endif %}
                </div>
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const section = document.querySelector('.dual-acc-sec.section-{{ section.id }}');
    if (!section) return;

    // prevent double-init (theme editor / section re-render)
    if (section.dataset.dualAccInit === '1') return;
    section.dataset.dualAccInit = '1';

    const wrapper = section.querySelector('.dual-acc-wrapper');
    const rightItems = Array.from(section.querySelectorAll('.right-acc-item'));
    const leftBtn = section.querySelector('.left-accordion-btn');
    const closeBtns = Array.from(section.querySelectorAll('.reveal-close, .reveal-close-mobile'));
    const videoElem = section.querySelector('#right-video');
    const revealWrap = section.querySelector('.right-reveal-content');

    /* -----------------------------
       A) Smooth RIGHT accordion
    ------------------------------*/
    function openItem(item) {
      const btn = item.querySelector('.right-acc-btn');
      const desc = item.querySelector('.right-acc-desc');
      if (!btn || !desc) return;

      item.classList.add('is-open');
      btn.classList.add('active');
      btn.setAttribute('aria-expanded', 'true');

      desc.style.height = desc.scrollHeight + 'px';

      const onEnd = (e) => {
        if (e.propertyName !== 'height') return;
        desc.style.height = 'auto';
        desc.removeEventListener('transitionend', onEnd);
      };
      desc.addEventListener('transitionend', onEnd);
    }

    function closeItem(item) {
      const btn = item.querySelector('.right-acc-btn');
      const desc = item.querySelector('.right-acc-desc');
      if (!btn || !desc) return;

      item.classList.remove('is-open');
      btn.classList.remove('active');
      btn.setAttribute('aria-expanded', 'false');

      desc.style.height = desc.scrollHeight + 'px';
      requestAnimationFrame(() => {
        desc.style.height = '0px';
      });
    }

    function closeAllExcept(exceptItem) {
      rightItems.forEach((it) => {
        if (it !== exceptItem) closeItem(it);
      });
    }

    if (rightItems.length) openItem(rightItems[0]);

    rightItems.forEach((item) => {
      const btn = item.querySelector('.right-acc-btn');
      if (!btn) return;

      btn.addEventListener('click', function () {
        const isOpen = item.classList.contains('is-open');
        closeAllExcept(item);
        if (isOpen) closeItem(item);
        else openItem(item);
      });
    });

    window.addEventListener('resize', function () {
      rightItems.forEach((item) => {
        if (!item.classList.contains('is-open')) return;
        const desc = item.querySelector('.right-acc-desc');
        if (!desc) return;
        if (desc.style.height !== 'auto') {
          desc.style.height = desc.scrollHeight + 'px';
        }
      });
    });

    /* -----------------------------
       B) Toggle ACTIVE reveal
    ------------------------------*/
    function setActive(next) {
      if (next) {
        section.classList.add('active');
        if (leftBtn) leftBtn.setAttribute('aria-expanded', 'true');
        if (revealWrap) revealWrap.setAttribute('aria-hidden', 'false');

        if (videoElem) {
          videoElem.muted = true;
          const p = videoElem.play();
          if (p && typeof p.catch === 'function') p.catch(() => {});
        }
      } else {
        section.classList.remove('active');
        if (leftBtn) leftBtn.setAttribute('aria-expanded', 'false');
        if (revealWrap) revealWrap.setAttribute('aria-hidden', 'true');

        if (videoElem) {
          videoElem.pause();
          videoElem.currentTime = 0;
        }
      }
    }

    if (leftBtn) {
      leftBtn.addEventListener('click', function () {
        const isActive = section.classList.contains('active');
        setActive(!isActive);
      });
    }

    closeBtns.forEach((btn) => {
      btn.addEventListener('click', function () {
        setActive(false);
      });
    });

    /* -----------------------------
       C) Background scroll motion (unchanged)
    ------------------------------*/
    if (wrapper) {
      let ticking = false;
      const MAX_MOVE = 90;

      function updateBg() {
        ticking = false;

        const r = wrapper.getBoundingClientRect();
        const vh = window.innerHeight || document.documentElement.clientHeight;

        if (!(r.bottom > 0 && r.top < vh)) return;

        const p = (r.top + r.height * 0.5) / vh;
        const progress = (p - 0.5) * 2;
        const y = Math.max(-1, Math.min(1, progress)) * MAX_MOVE;

        const neededScale = 1 + (2 * MAX_MOVE) / Math.max(1, r.height);
        const scale = Math.min(1.25, neededScale + 0.02);

        wrapper.style.setProperty("--bgTransform", `translate3d(0, ${y}px, 0) scale(${scale})`);
      }

      function onScroll() {
        if (!ticking) {
          ticking = true;
          requestAnimationFrame(updateBg);
        }
      }

      window.addEventListener("scroll", onScroll, { passive: true });
      window.addEventListener("resize", onScroll);
      onScroll();
    }
  });
  </script>
</section>

{% schema %}
{
  "name": "Dual Accordion + Video",
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "default": "background-2",
      "label": "t:sections.all.color_scheme.label"
    },
    {
      "type": "image_picker",
      "id": "bg_image",
      "label": "Background Image"
    },
    {
      "type": "text",
      "id": "left_title",
      "label": "Left Title"
    },
    {
      "type": "textarea",
      "id": "left_text",
      "label": "Left Text"
    },
    {
      "type": "text",
      "id": "left_acc_title_sub",
      "label": "Left Accordion Sub Title"
    },
    {
      "type": "text",
      "id": "left_acc_title",
      "label": "Left Accordion Title"
    },
    {
      "type": "textarea",
      "id": "left_acc_text",
      "label": "Left Accordion Text"
    },
    {
      "type": "video",
      "id": "left_video",
      "label": "Left Video URL"
    }
  ],
  "blocks": [
    {
      "type": "right_acc",
      "name": "Right Accordion",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title"
        },
        {
          "type": "richtext",
          "id": "text",
          "label": "Description"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Dual Accordion + Video"
    }
  ]
}
{% endschema %}
