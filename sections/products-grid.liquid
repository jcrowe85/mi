{{ 'template-collection.css' | asset_url | stylesheet_tag }}
{{ 'section-products-grid.css' | asset_url | stylesheet_tag }}
{{ 'component-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'component-rte.css' | asset_url | stylesheet_tag }}

<noscript>{{ 'component-price.css' | asset_url | stylesheet_tag }}</noscript>
<noscript>{{ 'component-rte.css' | asset_url | stylesheet_tag }}</noscript>

{%- if settings.quickview_show -%}
  {{ 'section-main-product.css' | asset_url | stylesheet_tag }}
  {{ 'component-deferred-media.css' | asset_url | stylesheet_tag }}
  {{ 'quick-add.css' | asset_url | stylesheet_tag }}
  <script src="{{ 'quick-add.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

{%- if settings.quickview_show == false and settings.show_color_swatch -%}
  {{ 'section-main-product.css' | asset_url | stylesheet_tag }}
{% endif %}

{%- style -%}
  .section-{{ section.id }}-padding {
    {% if section.settings.padding_top == 'no-indent' %}
      padding-top: 0;
    {% else %}
      padding-top: 3.2rem;
    {% endif %}

    {% if section.settings.padding_bottom == 'no-indent' %}
      padding-bottom: 0;
    {% else %}
      padding-bottom: 3.2rem;
    {% endif %}
  }

  @media screen and (min-width: 990px) {
    .section-{{ section.id }}-padding {
      {% if section.settings.padding_top == 'no-indent' %}
        padding-top: 0;
      {% elsif section.settings.padding_top == 'l' %}
        padding-top: 4rem;
      {% else %}
        padding-top: 3.2rem;
      {% endif %}

      {% if section.settings.padding_bottom == 'no-indent' %}
        padding-bottom: 0;
      {% elsif section.settings.padding_bottom == 'l' %}
        padding-bottom: 4rem;
      {% else %}
        padding-bottom: 3.2rem;
      {% endif %}
    }
  }

  @media screen and (min-width: 1200px) {
    .section-{{ section.id }}-padding {
      {% if section.settings.padding_top == 'no-indent' %}
        padding-top: 0;
      {% elsif section.settings.padding_top == 'l' %}
        padding-top: 8rem;
      {% elsif section.settings.padding_top == 'm' %}
        padding-top: 4rem;
      {% else %}
        padding-top: 3.2rem;
      {% endif %}

      {% if section.settings.padding_bottom == 'no-indent' %}
        padding-bottom: 0;
      {% elsif section.settings.padding_bottom == 'l' %}
        padding-bottom: 8rem;
      {% elsif section.settings.padding_bottom == 'm' %}
        padding-bottom: 4rem;
      {% else %}
        padding-bottom: 3.2rem;
      {% endif %}
    }
  }

  @media screen and (min-width: 1560px) {
    .section-{{ section.id }}-padding {
      {% if section.settings.padding_top == 'no-indent' %}
        padding-top: 0;
      {% elsif section.settings.padding_top == 'l' %}
        padding-top: 16rem;
      {% elsif section.settings.padding_top == 'm' %}
        padding-top: 8rem;
      {% elsif section.settings.padding_top == 's' %}
        padding-top: 4rem;
      {% else %}
        padding-top: 3.2rem;
      {% endif %}

      {% if section.settings.padding_bottom == 'no-indent' %}
        padding-bottom: 0;
      {% elsif section.settings.padding_bottom == 'l' %}
        padding-bottom: 16rem;
      {% elsif section.settings.padding_bottom == 'm' %}
        padding-bottom: 8rem;
      {% elsif section.settings.padding_bottom == 's' %}
        padding-bottom: 4rem;
      {% else %}
        padding-bottom: 3.2rem;
      {% endif %}
    }
  }
{%- endstyle -%}

{%- comment -%}
  Fallback automatic grid (if no blocks are configured):
  Uses collections.all.products and existing sort settings.
{%- endcomment -%}
{% liquid
  assign grid_products = collections.all.products
  case section.settings.sort
    when 'products_high', 'products_low'
      assign grid_products = grid_products | sort: 'price_min'
    when 'date', 'date_reversed'
      assign grid_products = grid_products | sort: 'published_at'
  endcase

  if section.settings.sort == 'products_high' or section.settings.sort == 'date_reversed' or section.settings.sort == 'alphabetical_reversed'
    assign grid_products = grid_products | reverse
  endif
%}

<div class="products-grid color-{{ section.settings.color_scheme }} background section-{{ section.id }}-padding">
  <div class="section-grid">
    {% liquid
      assign section_heading = section.settings.heading
      assign section_description = section.settings.description
      assign section_button_label = section.settings.button_label
      assign section_button_link = section.settings.button_link
    %}

    {%- if section_heading != blank or section_button_label != blank -%}
      <div class="section-header__line">
        <div class="container">
          <div class="section-header__item">
            <div class="section-header__title__block">
              <div class="section-header__title-item">
                {%- if section_heading != blank -%}
                  <h2 class="section-header__title title--section h1">
                    {{ section_heading }}
                  </h2>
                {% endif %}
              </div>
              <div class="button-description-wrap">
                {%- if section_description != blank -%}
                  <div class="section-header__desc richtext__content large-font">
                    {{ section_description }}
                  </div>
                {% endif %}
                {% if section_button_label != blank %}
                  <a href="{{ section_button_link }}">{{ section_button_label }}
                    <svg class="icon icon-button-arrow" width="14" height="12" viewBox="0 0 14 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M7.97218 1L12.8333 6M12.8333 6L7.97218 11M12.8333 6L1.16663 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    {%- endif -%}

    <div class="container">
      <div class="products-grid full-width content">
        <ul
          id="products-grid"
          data-id="{{ section.id }}"
          class="collection-product-list {% if section.settings.show_two_cards %} collection-product-list--2-mobile{% endif %}"
        >
          {%- if section.blocks.size > 0 -%}
            {%- comment -%}
              Manual mode: use blocks so you can choose order + media per product.
            {%- endcomment -%}
            {%- for block in section.blocks -%}
              {%- assign product = all_products[block.settings.product] -%}
              {%- if product -%}
                <li
                  class="collection-product-card"
                  style="
                    {% if block.settings.card_bg != blank %}--card-bg: {{ block.settings.card_bg }};{% endif %}
                    {% if block.settings.button_bg != blank %}--button-bg: {{ block.settings.button_bg }};{% endif %}
                    {% if block.settings.button_text != blank %}--button-text: {{ block.settings.button_text }};{% endif %}
                    {% if block.settings.button_bg_hover != blank %}--button-bg-hover: {{ block.settings.button_bg_hover }};{% endif %}
                    {% if block.settings.button_text_hover != blank %}--button-text-hover: {{ block.settings.button_text_hover }};{% endif %}
                  "
                  {{ block.shopify_attributes }}
                  data-hevc-desktop="{{ block.settings.hover_video_hevc_desktop | escape }}"
                  data-hevc-mobile="{{ block.settings.hover_video_hevc_mobile | escape }}"
                  data-webm-desktop="{{ block.settings.hover_video_webm_desktop | escape }}"
                  data-webm-mobile="{{ block.settings.hover_video_webm_mobile | escape }}"
                  data-mp4-desktop="{{ block.settings.hover_video_mp4_desktop | escape }}"
                  data-mp4-mobile="{{ block.settings.hover_video_mp4_mobile | escape }}"
                >
                  {% render 'product-card',
                    product_card_product: product,
                    media_size: section.settings.image_ratio,
                    media_fit: section.settings.image_fit,
                    show_secondary_image: section.settings.show_secondary_image,
                    show_vendor: section.settings.show_vendor,
                    show_collection_name: section.settings.show_collection_name,
                    show_color_swatch: section.settings.show_color_swatch,
                    show_desc: section.settings.show_desc,
                    hide_product_summary: section.settings.hide_product_summary,
                    hide_product_reviews: section.settings.hide_product_reviews,
                    pro_hide_price_inner_btn: section.settings.pro_hide_price_inner_btn,
                    section_id: section.id,
                    add_id: forloop.index,
                    show_sku: section.settings.show_sku,
                    custom_static_image: block.settings.static_image,
                    custom_image_width: block.settings.image_width,

                    /*
                      Keep backwards compatibility in case your snippet still expects these names.
                      We'll pass "desktop" as the default values.
                    */
                    hover_video_hevc: block.settings.hover_video_hevc_desktop,
                    hover_video_webm: block.settings.hover_video_webm_desktop,
                    hover_video_fallback: block.settings.hover_video_mp4_desktop
                  %}
                </li>
              {%- endif -%}
            {%- endfor -%}

          {%- elsif grid_products.size > 0 -%}
            {%- comment -%}
              Fallback automatic mode: old behavior using collections.all.products
            {%- endcomment -%}
            {%- for product in grid_products limit: section.settings.products_per_page -%}
              <li class="collection-product-card">
                {% render 'product-card',
                  product_card_product: product,
                  media_size: section.settings.image_ratio,
                  media_fit: section.settings.image_fit,
                  show_secondary_image: section.settings.show_secondary_image,
                  show_vendor: section.settings.show_vendor,
                  show_collection_name: section.settings.show_collection_name,
                  show_color_swatch: section.settings.show_color_swatch,
                  show_desc: section.settings.show_desc,
                  hide_product_summary: section.settings.hide_product_summary,
                  hide_product_reviews: section.settings.hide_product_reviews,
                  pro_hide_price_inner_btn: section.settings.pro_hide_price_inner_btn,
                  section_id: section.id,
                  add_id: forloop.index,
                  show_sku: section.settings.show_sku
                %}
              </li>
            {%- endfor -%}

          {%- else -%}
            {%- for i in (1..4) -%}
              <div class="popular-products__item_placeholder collection-popular-card collection-popular-card--placeholder">
                {% render 'product-card-placeholder',
                  media_ratio: section.settings.image_ratio,
                  show_vendor: section.settings.show_vendor
                %}
              </div>
            {%- endfor -%}
          {%- endif -%}
        </ul>
      </div>

      <div class="button-description-wrap mobile-show-only-btn">
        {% if section_button_label != blank %}
          <a href="{{ section_button_link }}">{{ section_button_label }}
            <svg class="icon icon-button-arrow" width="14" height="12" viewBox="0 0 14 12" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M7.97218 1L12.8333 6M12.8333 6L7.97218 11M12.8333 6L1.16663 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const sectionRoot = document.querySelector('[data-id="{{ section.id }}"]');
    if (!sectionRoot) return;

    const productCards = sectionRoot.querySelectorAll('.collection-product-card');

    // --- Helpers ---
    const isMobile = () => window.matchMedia('(max-width: 989px)').matches;

    const canPlayHEVC = () => {
      const v = document.createElement('video');
      // Safari/iOS HEVC in MP4/MOV typically reports under video/mp4 with hvc1 codec tag.
      return !!(v.canPlayType && v.canPlayType('video/mp4; codecs="hvc1"').replace(/no/, ''));
    };

    const canPlayWebM = () => {
      const v = document.createElement('video');
      return !!(v.canPlayType && v.canPlayType('video/webm; codecs="vp9"').replace(/no/, ''));
    };

    const pickUrl = (card) => {
      const mobile = isMobile();

      const hevc = mobile ? card.dataset.hevcMobile : card.dataset.hevcDesktop;
      const webm = mobile ? card.dataset.webmMobile : card.dataset.webmDesktop;
      const mp4  = mobile ? card.dataset.mp4Mobile  : card.dataset.mp4Desktop;

      // Priority: Safari HEVC alpha -> WebM alpha -> MP4 fallback
      if (hevc && canPlayHEVC()) return { url: hevc, type: 'video/mp4; codecs="hvc1"' };
      if (webm && canPlayWebM()) return { url: webm, type: 'video/webm' };
      if (mp4) return { url: mp4, type: 'video/mp4' };
      return null;
    };

    const setVideoSource = (video, picked) => {
      if (!video || !picked || !picked.url) return;

      // Avoid reloading if already set
      const current = video.getAttribute('data-active-src');
      if (current === picked.url) return;

      // Replace sources
      while (video.firstChild) video.removeChild(video.firstChild);

      const source = document.createElement('source');
      source.src = picked.url;
      source.type = picked.type || '';
      video.appendChild(source);

      // mark + reload
      video.setAttribute('data-active-src', picked.url);
      video.load();
    };

    // Initial source selection
    productCards.forEach(card => {
      const video = card.querySelector('.product-card__hover-video');
      if (!video) return;

      // Recommended attributes for mobile stability
      video.muted = true;
      video.playsInline = true;
      video.loop = true;

      // Let Safari decide buffering; don't force all videos to preload hard
      // If your snippet sets preload already, JS won't hurt it.
      if (!video.getAttribute('preload')) video.setAttribute('preload', 'metadata');

      const picked = pickUrl(card);
      setVideoSource(video, picked);
    });

    // Re-pick sources on resize/orientation changes (debounced)
    let resizeTimer = null;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        productCards.forEach(card => {
          const video = card.querySelector('.product-card__hover-video');
          if (!video) return;
          const picked = pickUrl(card);
          setVideoSource(video, picked);
        });
      }, 200);
    });

    // Existing hover behavior (desktop)
    productCards.forEach(card => {
      card.addEventListener('mouseenter', function() {
        productCards.forEach(c => c.classList.remove('active'));
        this.classList.add('active');

        const video = this.querySelector('.product-card__hover-video');
        if (video && video.paused) {
          video.play().catch(() => {});
        }
      });
    });
  });
</script>

{% schema %}
{
  "name": "t:sections.products-grid.name",
  "tag": "section",
  "class": "products-grid-section",
  "disabled_on": {
    "templates": ["password"],
    "groups": ["*"]
  },
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "default": "background-2",
      "label": "t:sections.all.color_scheme.label"
    },
    {
      "type": "inline_richtext",
      "id": "heading",
      "default": "Heading",
      "label": "t:sections.all.heading.label"
    },
    {
      "type": "richtext",
      "id": "description",
      "default": "<p>Description</p>",
      "label": "t:sections.all.subheading.label"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "min": 3,
      "max": 50,
      "step": 1,
      "default": 8,
      "label": "t:sections.products-grid.settings.products_per_page.label"
    },
    {
      "type": "select",
      "id": "sort",
      "options": [
        { "value": "alphabetical", "label": "t:sections.products-grid.settings.sort.options__1.label" },
        { "value": "alphabetical_reversed", "label": "t:sections.products-grid.settings.sort.options__2.label" },
        { "value": "date_reversed", "label": "t:sections.products-grid.settings.sort.options__3.label" },
        { "value": "date", "label": "t:sections.products-grid.settings.sort.options__4.label" },
        { "value": "products_high", "label": "t:sections.products-grid.settings.sort.options__5.label" },
        { "value": "products_low", "label": "t:sections.products-grid.settings.sort.options__6.label" }
      ],
      "default": "alphabetical",
      "label": "t:sections.products-grid.settings.sort.label"
    },
    {
      "type": "header",
      "content": "t:sections.all.product_card.header.content"
    },
    {
      "type": "checkbox",
      "id": "show_two_cards",
      "default": false,
      "label": "t:sections.all.product_card.mobile_card_count.label"
    },
    {
      "type": "checkbox",
      "id": "show_secondary_image",
      "default": true,
      "label": "t:sections.all.product_card.show_secondary_image.label"
    },
    {
      "type": "checkbox",
      "id": "show_sku",
      "default": false,
      "label": "t:sections.all.sku.show_sku"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": true,
      "label": "t:sections.all.product_card.show_vendor.label"
    },
    {
      "type": "checkbox",
      "id": "show_collection_name",
      "default": true,
      "label": "t:sections.all.product_card.show_colection_name.label"
    },
    {
      "type": "checkbox",
      "id": "show_desc",
      "default": false,
      "label": "t:sections.all.product_card.show_description.label"
    },
    {
      "type": "checkbox",
      "id": "show_color_swatch",
      "default": false,
      "label": "t:sections.all.product_card.show_color.label"
    },
    {
      "type": "header",
      "content": "t:sections.all.image.header.content"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "options": [
        { "value": "landscape", "label": "t:sections.all.image.ratio.options__1.label" },
        { "value": "portrait", "label": "t:sections.all.image.ratio.options__2.label" },
        { "value": "square", "label": "t:sections.all.image.ratio.options__3.label" }
      ],
      "default": "portrait",
      "label": "t:sections.all.image.ratio.label"
    },
    {
      "type": "select",
      "id": "image_fit",
      "label": "t:sections.all.image.fit.label",
      "options": [
        { "value": "contain", "label": "t:sections.all.image.fit.options__1.label" },
        { "value": "cover", "label": "t:sections.all.image.fit.options__2.label" }
      ],
      "default": "cover"
    },
    {
      "type": "header",
      "content": "t:sections.all.button.header.content"
    },
    {
      "type": "text",
      "id": "button_label",
      "default": "Button label",
      "label": "t:sections.all.button.label.label",
      "info": "t:sections.all.button.label.info"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "t:sections.all.button.link.label"
    },
    {
      "type": "checkbox",
      "id": "button_arrow",
      "default": true,
      "label": "t:sections.all.button.arrow.label"
    },
    {
      "type": "checkbox",
      "id": "hide_product_summary",
      "default": true,
      "label": "Hide Product Summary"
    },
    {
      "type": "checkbox",
      "id": "hide_product_reviews",
      "default": true,
      "label": "Hide Product Reviews"
    },
    {
      "type": "checkbox",
      "id": "pro_hide_price_inner_btn",
      "default": true,
      "label": "Hide Product Price"
    },
    {
      "type": "header",
      "content": "t:sections.all.section-padding.header.content"
    },
    {
      "type": "select",
      "id": "padding_top",
      "options": [
        { "value": "no-indent", "label": "t:sections.all.section-padding.options__1.label" },
        { "value": "xs", "label": "t:sections.all.section-padding.options__2.label" },
        { "value": "s", "label": "t:sections.all.section-padding.options__3.label" },
        { "value": "m", "label": "t:sections.all.section-padding.options__4.label" },
        { "value": "l", "label": "t:sections.all.section-padding.options__5.label" }
      ],
      "default": "s",
      "label": "t:sections.all.section-padding.padding_top.label"
    },
    {
      "type": "select",
      "id": "padding_bottom",
      "options": [
        { "value": "no-indent", "label": "t:sections.all.section-padding.options__1.label" },
        { "value": "xs", "label": "t:sections.all.section-padding.options__2.label" },
        { "value": "s", "label": "t:sections.all.section-padding.options__3.label" },
        { "value": "m", "label": "t:sections.all.section-padding.options__4.label" },
        { "value": "l", "label": "t:sections.all.section-padding.options__5.label" }
      ],
      "default": "s",
      "label": "t:sections.all.section-padding.padding_bottom.label"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product card",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "image_picker",
          "id": "static_image",
          "label": "Static image override"
        },
        {
          "type": "range",
          "id": "image_width",
          "label": "Image width",
          "min": 50,
          "max": 150,
          "step": 5,
          "unit": "%",
          "default": 100
        },
        {
          "type": "color",
          "id": "card_bg",
          "label": "Card background color",
          "default": "#ffffff"
        },
        {
          "type": "header",
          "content": "Shop Now Button Colors (Per Card)"
        },
        {
          "type": "color",
          "id": "button_bg",
          "label": "Button background color",
          "default": "#ffffff"
        },
        {
          "type": "color",
          "id": "button_text",
          "label": "Button text color",
          "default": "#000000"
        },
        {
          "type": "color",
          "id": "button_bg_hover",
          "label": "Button hover background (optional)",
          "default": "#ffffff"
        },
        {
          "type": "color",
          "id": "button_text_hover",
          "label": "Button hover text (optional)",
          "default": "#000000"
        },
        {
          "type": "header",
          "content": "Hover video URLs (Desktop)"
        },
        {
          "type": "url",
          "id": "hover_video_hevc_desktop",
          "label": "Desktop HEVC alpha URL (Safari)"
        },
        {
          "type": "url",
          "id": "hover_video_webm_desktop",
          "label": "Desktop WebM alpha URL (Chrome/Firefox)"
        },
        {
          "type": "url",
          "id": "hover_video_mp4_desktop",
          "label": "Desktop MP4 fallback URL"
        },
        {
          "type": "header",
          "content": "Hover video URLs (Mobile)"
        },
        {
          "type": "url",
          "id": "hover_video_hevc_mobile",
          "label": "Mobile HEVC alpha URL (Safari) â€” e.g. your 320w encode"
        },
        {
          "type": "url",
          "id": "hover_video_webm_mobile",
          "label": "Mobile WebM alpha URL (Chrome/Firefox)"
        },
        {
          "type": "url",
          "id": "hover_video_mp4_mobile",
          "label": "Mobile MP4 fallback URL"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "t:sections.products-grid.name"
    }
  ]
}
{% endschema %}
